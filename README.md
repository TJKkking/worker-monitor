# ğŸ›°ï¸ worker-monitor

`worker-monitor` æ˜¯ä¸€ä¸ªä¸º Kubernetes å·¥ä½œèŠ‚ç‚¹è®¾è®¡çš„è½»é‡çº§ç›‘æ§ç»„ä»¶ï¼Œç”¨äºé‡‡é›†æ¯ç§’çº§åˆ«çš„ç³»ç»Ÿèµ„æºçŠ¶æ€ï¼ˆCPUã€å†…å­˜ã€ç½‘ç»œé€Ÿç‡ï¼‰ä»¥åŠèŠ‚ç‚¹é—´ç½‘ç»œå»¶è¿Ÿï¼Œå¹¶é€šè¿‡ HTTP æ¥å£ä¾›è°ƒåº¦å™¨è®¿é—®ã€‚

æœ¬é¡¹ç›®ç”¨äºæ”¯æŒæ·±åº¦å¼ºåŒ–å­¦ä¹ è°ƒåº¦å™¨åœ¨ 5GC ç½‘ç»œä¸­çš„æ„ŸçŸ¥èƒ½åŠ›ã€‚

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- æ¯ç§’é‡‡é›†ï¼š
  - ğŸ§  CPU ä½¿ç”¨ç‡
  - ğŸ§® å†…å­˜ä½¿ç”¨ç‡
  - ğŸŒ ç½‘ç»œæ¥æ”¶/å‘é€é€Ÿç‡ï¼ˆMbpsï¼‰
- æ¯ 5 ç§’æ¢æµ‹ï¼š
  - ğŸ“¡ ä¸å…¶ä»–èŠ‚ç‚¹çš„ç½‘ç»œå»¶è¿Ÿï¼ˆmsï¼‰
- HTTP REST æ¥å£æä¾› JSON æ ¼å¼ `/stats` å“åº”
- æ”¯æŒ systemd å¯åŠ¨ï¼Œå¼€æœºè‡ªå¯
- æ˜“äºé›†æˆã€æ‰©å±•å’Œå®¹å™¨åŒ–

---

## ğŸ“¦ å®‰è£…ä¸éƒ¨ç½²

### 1ï¸âƒ£ å‡†å¤‡ `peers.txt`

åœ¨æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªåä¸º `peers.txt` çš„æ–‡æœ¬æ–‡ä»¶ï¼Œç”¨äºå®šä¹‰éœ€è¦æ¢æµ‹å»¶è¿Ÿçš„èŠ‚ç‚¹åˆ—è¡¨ï¼š

```txt
192.168.1.101
192.168.1.102
```

---

### 2ï¸âƒ£ ä¸€é”®å®‰è£…ï¼ˆå»ºè®®åœ¨æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹æ‰§è¡Œï¼‰

```bash
curl -fsSL https://raw.githubusercontent.com/tjkkking/worker-monitor/main/install_monitor.sh | bash
```

> ğŸ“Œ éœ€è¦é¢„å…ˆç¡®ä¿ `peers.txt` å·²å­˜åœ¨äºä»“åº“ä¸­ã€‚

---

### 3ï¸âƒ£ å¯åŠ¨éªŒè¯

```bash
curl http://localhost:8080/stats
```

é¢„æœŸè¿”å›å¦‚ä¸‹ç»“æ„ï¼š

```json
{
  "nodeName": "node-1",
  "timestamp": 1712640000,
  "cpu": 0.35,
  "mem": 0.72,
  "net": {
    "rx": 5.8,
    "tx": 3.2
  },
  "latency": {
    "192.168.1.101": 0.8,
    "192.168.1.102": 1.3
  }
}
```

---

## ğŸ”§ æ‰‹åŠ¨æ“ä½œå‘½ä»¤

| æ“ä½œ                   | å‘½ä»¤                                    |
| ---------------------- | --------------------------------------- |
| æŸ¥çœ‹è¿è¡ŒçŠ¶æ€           | `systemctl status worker-monitor`       |
| é‡å¯æœåŠ¡               | `sudo systemctl restart worker-monitor` |
| ä¿®æ”¹ç›‘æ§ä»£ç åé‡è½½æœåŠ¡ | `sudo systemctl daemon-reload` + é‡å¯   |
| å¸è½½ç›‘æ§æœåŠ¡           | `sudo ./uninstall_monitor.sh`           |

---

## ğŸ§ª å¼€å‘ä¾èµ–ï¼ˆæœ¬åœ°è¿è¡Œï¼‰

```bash
pip install fastapi uvicorn psutil ping3
uvicorn main:app --host 0.0.0.0 --port 8080
```

---

## ğŸ“ ç›®å½•ç»“æ„

```text
worker-monitor/
â”œâ”€â”€ main.py                # ç›‘æ§ä¸»ç¨‹åº
â”œâ”€â”€ peers.txt              # èŠ‚ç‚¹åˆ—è¡¨æ–‡ä»¶
â”œâ”€â”€ requirements.txt       # Python ä¾èµ–
â”œâ”€â”€ install_monitor.sh # å®‰è£…è„šæœ¬
â”œâ”€â”€ uninstall_monitor.sh # å¸è½½è„šæœ¬
â””â”€â”€ README.md              # ä½¿ç”¨è¯´æ˜
```

---

## ğŸ“® æ¥å£è¯´æ˜

### `GET /stats`

è¿”å›å½“å‰èŠ‚ç‚¹çš„ç›‘æ§çŠ¶æ€ã€‚

å­—æ®µè¯´æ˜ï¼š

| å­—æ®µ      | ç±»å‹   | è¯´æ˜                 |
| --------- | ------ | -------------------- |
| nodeName  | string | èŠ‚ç‚¹ä¸»æœºå           |
| timestamp | int    | å½“å‰æ—¶é—´æˆ³           |
| cpu       | float  | CPU ä½¿ç”¨ç‡ï¼ˆ0~1ï¼‰    |
| mem       | float  | å†…å­˜ä½¿ç”¨ç‡ï¼ˆ0~1ï¼‰    |
| net.rx    | float  | æ¥æ”¶é€Ÿç‡ï¼ˆMbpsï¼‰     |
| net.tx    | float  | å‘é€é€Ÿç‡ï¼ˆMbpsï¼‰     |
| latency   | dict   | ä¸å„èŠ‚ç‚¹çš„å»¶è¿Ÿï¼ˆmsï¼‰ |

---

## ğŸ“„ License

MIT License Â© 2024 [tjkkking](https://github.com/tjkkking)
